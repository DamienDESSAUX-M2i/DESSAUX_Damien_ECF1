version: '3.8'

# =============================================================================
# ECF DataPulse Analytics - Infrastructure Docker
# Architecture : Data Lakehouse (MongoDB + PostgreSQL + MinIO)
# =============================================================================

services:

  # ===========================================================================
  # MongoDB - Couches Bronze et Silver
  # ===========================================================================
  mongodb:
    image: mongo:7.0
    container_name: datapulse_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-datapulse2026}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./init/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - datapulse_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===========================================================================
  # Mongo Express - Interface d'administration MongoDB
  # ===========================================================================
  mongo-express:
    image: mongo-express:latest
    container_name: datapulse_mongo_express
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASSWORD:-datapulse2026}
      ME_CONFIG_MONGODB_URL: mongodb://admin:${MONGO_PASSWORD:-datapulse2026}@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-admin2026}
    ports:
      - "8081:8081"
    networks:
      - datapulse_network

  # ===========================================================================
  # PostgreSQL - Couche Gold (données analytiques)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: datapulse_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: datapulse
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datapulse2026}
      POSTGRES_DB: datapulse
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - datapulse_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U datapulse -d datapulse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===========================================================================
  # pgAdmin - Interface d'administration PostgreSQL
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: datapulse_pgadmin
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@datapulse.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin2026}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_DISABLE_POSTFIX: 'True'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - datapulse_network

  # ===========================================================================
  # MinIO - Stockage objet (fichiers bruts, exports)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: datapulse_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-datapulse}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-datapulse2026}
    ports:
      - "9000:9000"   # API S3
      - "9001:9001"   # Console Web
    volumes:
      - minio_data:/data
    networks:
      - datapulse_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===========================================================================
  # Pipeline ETL - Service Python pour l'exécution du pipeline
  # ===========================================================================
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: datapulse_pipeline
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      # MongoDB
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_USER: admin
      MONGO_PASSWORD: ${MONGO_PASSWORD:-datapulse2026}
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: datapulse
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datapulse2026}
      POSTGRES_DB: datapulse
      # MinIO
      MINIO_HOST: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-datapulse}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-datapulse2026}
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./sql:/app/sql
      - ./logs:/app/logs
    networks:
      - datapulse_network
    # Le conteneur reste actif pour execution manuelle
    entrypoint: []
    command: ["tail", "-f", "/dev/null"]

# =============================================================================
# Volumes persistants
# =============================================================================
volumes:
  mongodb_data:
    name: datapulse_mongodb_data
  postgres_data:
    name: datapulse_postgres_data
  pgadmin_data:
    name: datapulse_pgadmin_data
  minio_data:
    name: datapulse_minio_data

# =============================================================================
# Réseau isolé
# =============================================================================
networks:
  datapulse_network:
    name: datapulse_network
    driver: bridge
